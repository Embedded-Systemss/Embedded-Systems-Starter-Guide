/*
 * RFID Laser Security System with Servo Door Lock
 * 
 * Features:
 * - RFID card-based access control
 * - Laser beam security alarm
 * - Servo motor door lock
 * - LCD status display
 * - Buzzer alerts
 * 
 * Card Functions:
 * - Card 1 (Alarm Card): Arms/disarms laser security system
 * - Card 2 (Door Card): Opens/closes servo door lock
 * 
 * Components:
 * - Arduino UNO R3
 * - MFRC522 RFID Reader
 * - LCD1602 I2C Display
 * - KY-008 Laser Module
 * - LDR Photosensitive Sensor
 * - Active Buzzer (3-pin)
 * - SG90 Servo Motor
 */

#include <SPI.h>
#include <MFRC522.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Servo.h>

// ============================================
// PIN DEFINITIONS
// ============================================
#define RST_PIN 9           // RFID Reset pin
#define SS_PIN 10           // RFID SDA/SS pin
#define LASER_PIN 3         // Laser module signal pin
#define LDR_PIN A0          // LDR sensor analog pin
#define BUZZER_PIN 8        // Buzzer signal pin
#define SERVO_PIN 6         // Servo motor signal pin

// ============================================
// COMPONENT INITIALIZATION
// ============================================
MFRC522 rfid(SS_PIN, RST_PIN);              // RFID reader
LiquidCrystal_I2C lcd(0x27, 16, 2);         // LCD (change to 0x3F if needed)
Servo doorServo;                             // Servo motor

// ============================================
// SYSTEM VARIABLES
// ============================================
// Alarm system state
bool systemArmed = false;                    // Is alarm system armed?
bool alarmTriggered = false;                 // Is alarm currently triggered?

// Door state
bool doorOpen = false;                       // Is door currently open?

// LDR threshold (adjust based on your setup)
int ldrThreshold = 500;                      // Alarm triggers when LDR > this value (inverted sensor)

// Debounce for RFID scanning
unsigned long lastDebounceTime = 0;          // Last time card was scanned
unsigned long debounceDelay = 2000;          // Minimum time between scans (2 seconds)

// ============================================
// RFID CARD UIDs - CHANGE THESE TO YOUR CARDS!
// ============================================
// Use RFID test code to get your actual card UIDs
byte alarmCardUID[] = {0xC7, 0x43, 0x53, 0x24};  // Card 1: Controls alarm system
byte doorCardUID[] = {0xDE, 0xAD, 0xBE, 0xEF};   // Card 2: Controls door - CHANGE THIS!

// ============================================
// SETUP - RUNS ONCE AT STARTUP
// ============================================
void setup() {
  // Initialize Serial communication
  Serial.begin(9600);
  Serial.println("======================================");
  Serial.println("RFID Security System with Servo Door");
  Serial.println("======================================");
  
  // Initialize SPI for RFID
  SPI.begin();
  rfid.PCD_Init();
  
  // Initialize LCD
  lcd.init();
  lcd.backlight();
  lcd.clear();
  
  // Display startup message
  lcd.setCursor(0, 0);
  lcd.print("Security System");
  lcd.setCursor(0, 1);
  lcd.print("Initializing...");
  delay(2000);
  
  // Setup digital pins
  pinMode(LASER_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LDR_PIN, INPUT);
  
  // Initialize servo
  doorServo.attach(SERVO_PIN);
  doorServo.write(0);                        // Start with door closed (0 degrees)
  
  // Turn off buzzer
  digitalWrite(BUZZER_PIN, LOW);
  digitalWrite(LASER_PIN, LOW);              // Start with laser off
  
  // Display initial state
  updateDisplay();
  
  Serial.println("\nSystem Ready!");
  Serial.println("Scan alarm card to arm/disarm security");
  Serial.println("Scan door card to open/close door");
  Serial.println("======================================\n");
}

// ============================================
// MAIN LOOP - RUNS CONTINUOUSLY
// ============================================
void loop() {
  // Check for RFID card present
  if (rfid.PICC_IsNewCardPresent() && rfid.PICC_ReadCardSerial()) {
    
    // Debounce - ignore scans within 2 seconds of last scan
    if (millis() - lastDebounceTime > debounceDelay) {
      lastDebounceTime = millis();
      
      // Identify which card was scanned
      if (compareUID(alarmCardUID)) {
        // Alarm card scanned
        Serial.println("Alarm card detected");
        toggleAlarmSystem();
        
      } else if (compareUID(doorCardUID)) {
        // Door card scanned
        Serial.println("Door card detected");
        toggleDoor();
        
      } else {
        // Unknown card
        Serial.println("Unknown card - Access Denied!");
        accessDenied();
      }
    }
    
    // Halt card and stop crypto
    rfid.PICC_HaltA();
    rfid.PCD_StopCrypto1();
  }
  
  // Monitor laser beam if system is armed
  if (systemArmed && !alarmTriggered) {
    int ldrValue = analogRead(LDR_PIN);
    
    // Print LDR value for debugging
    Serial.print("LDR: ");
    Serial.println(ldrValue);
    
    // Check if laser beam is broken (LDR value increases for inverted sensor)
    if (ldrValue > ldrThreshold) {
      triggerAlarm();
    }
  }
  
  // Handle alarm state - continuous beeping
  if (alarmTriggered) {
    digitalWrite(BUZZER_PIN, HIGH);
    delay(200);
    digitalWrite(BUZZER_PIN, LOW);
    delay(200);
  }
  
  delay(100);                                // Small delay for stability
}

// ============================================
// FUNCTION: Compare RFID UIDs
// ============================================
bool compareUID(byte* uid) {
  for (byte i = 0; i < 4; i++) {
    if (rfid.uid.uidByte[i] != uid[i]) {
      return false;
    }
  }
  return true;
}

// ============================================
// FUNCTION: Toggle Alarm System (Arm/Disarm)
// ============================================
void toggleAlarmSystem() {
  systemArmed = !systemArmed;
  alarmTriggered = false;                    // Reset alarm trigger
  
  if (systemArmed) {
    // ARM THE SYSTEM
    digitalWrite(LASER_PIN, HIGH);           // Turn on laser
    
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("System Armed");
    lcd.setCursor(0, 1);
    lcd.print("Laser Active");
    
    // Single beep confirmation
    digitalWrite(BUZZER_PIN, HIGH);
    delay(100);
    digitalWrite(BUZZER_PIN, LOW);
    
    Serial.println(">>> ALARM SYSTEM ARMED <<<");
    Serial.println("Monitoring laser beam...");
    
  } else {
    // DISARM THE SYSTEM
    digitalWrite(LASER_PIN, LOW);            // Turn off laser
    digitalWrite(BUZZER_PIN, LOW);           // Turn off alarm if active
    
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("System Disabled");
    lcd.setCursor(0, 1);
    lcd.print("Laser Off");
    
    // Double beep confirmation
    digitalWrite(BUZZER_PIN, HIGH);
    delay(100);
    digitalWrite(BUZZER_PIN, LOW);
    delay(100);
    digitalWrite(BUZZER_PIN, HIGH);
    delay(100);
    digitalWrite(BUZZER_PIN, LOW);
    
    Serial.println(">>> ALARM SYSTEM DISARMED <<<");
  }
  
  delay(2000);
  updateDisplay();
}

// ============================================
// FUNCTION: Toggle Door (Open/Close)
// ============================================
void toggleDoor() {
  doorOpen = !doorOpen;
  
  if (doorOpen) {
    // OPEN DOOR
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Opening Door...");
    
    Serial.println(">>> OPENING DOOR <<<");
    
    doorServo.write(180);                    // Rotate to 180 degrees (open position)
    
    // Single beep confirmation
    digitalWrite(BUZZER_PIN, HIGH);
    delay(200);
    digitalWrite(BUZZER_PIN, LOW);
    
    lcd.setCursor(0, 1);
    lcd.print("Door OPEN");
    
    Serial.println("Door is now OPEN (180 degrees)");
    delay(2000);
    
  } else {
    // CLOSE DOOR
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Closing Door...");
    
    Serial.println(">>> CLOSING DOOR <<<");
    
    doorServo.write(0);                      // Rotate to 0 degrees (closed position)
    
    // Double beep confirmation
    digitalWrite(BUZZER_PIN, HIGH);
    delay(100);
    digitalWrite(BUZZER_PIN, LOW);
    delay(100);
    digitalWrite(BUZZER_PIN, HIGH);
    delay(100);
    digitalWrite(BUZZER_PIN, LOW);
    
    lcd.setCursor(0, 1);
    lcd.print("Door CLOSED");
    
    Serial.println("Door is now CLOSED (0 degrees)");
    delay(2000);
  }
  
  updateDisplay();
}

// ============================================
// FUNCTION: Trigger Alarm
// ============================================
void triggerAlarm() {
  alarmTriggered = true;
  
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("!!! ALARM !!!");
  lcd.setCursor(0, 1);
  lcd.print("Breach Detected");
  
  Serial.println("\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!");
  Serial.println("!!! ALARM TRIGGERED !!!");
  Serial.println("!!! LASER BEAM BROKEN !!!");
  Serial.println("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n");
}

// ============================================
// FUNCTION: Access Denied (Unknown Card)
// ============================================
void accessDenied() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Access Denied!");
  lcd.setCursor(0, 1);
  lcd.print("Unknown Card");
  
  // Long beep
  digitalWrite(BUZZER_PIN, HIGH);
  delay(500);
  digitalWrite(BUZZER_PIN, LOW);
  
  delay(1500);
  updateDisplay();
}

// ============================================
// FUNCTION: Update LCD Display
// ============================================
void updateDisplay() {
  lcd.clear();
  
  // TOP LINE: System status
  lcd.setCursor(0, 0);
  if (systemArmed) {
    lcd.print("Armed");
  } else {
    lcd.print("Disarmed");
  }
  
  // Add door status to top line
  lcd.setCursor(9, 0);
  if (doorOpen) {
    lcd.print("Dr:OPEN");
  } else {
    lcd.print("Dr:SHUT");
  }
  
  // BOTTOM LINE: Instructions or status
  lcd.setCursor(0, 1);
  if (alarmTriggered) {
    lcd.print("BREACH!");
  } else if (systemArmed) {
    lcd.print("Monitoring...");
  } else {
    lcd.print("Scan RFID Card");
  }
}
